name: irods-s3-api-tests

services:
    irods-catalog:
        build:
            context: irods_catalog
        environment:
            - POSTGRES_PASSWORD=testpassword
        restart: always

    irods-catalog-provider:
        build:
            context: irods_catalog_provider
        healthcheck:
            test: ils || exit 1
            start_period: 20s
            interval: 10s
            timeout: 10s
            retries: 20
        depends_on:
            - irods-catalog

    irods-s3-api:
        build:
            context: ../..
            dockerfile: irods_runner.Dockerfile
        volumes:
            - ./config.json:/config.json:ro
        depends_on:
            irods-catalog-provider:
                condition: service_healthy

    test-runner:
        build:
            context: test_runner
        depends_on:
            irods-catalog-provider:
                condition: service_healthy
            irods-s3-api:
                condition: service_started
        volumes:
            - ../../:/irods_client_s3_cpp
